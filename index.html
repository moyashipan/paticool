<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<meta property="og:description" content="@Moyashipan">
		<title>@Moyashipan</title>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
		<script type="text/javascript">
			var _gaq = _gaq || [];
			_gaq.push(['_setAccount', 'UA-32407364-1']);
			_gaq.push(['_trackPageview']);
			(function() {
				var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
				ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
				var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
			})();
		</script>
		<script>
			var main = {
				IMAGE_URL: 'data:image/png;base64,'+
				'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'+
				'RK5CYII=',
				canvas: null,
				context: null,
				image: null,
				IMAGE_SCALE: 3,
				vertices: null,
				drawTimer: null,
				drawDelay: 30,
				counter: 0,
				counterScale: 100,
				MAX_COUNTER: Math.PI * 100,
				WAVE_LENGTH: 15,
				init: function(callback){
					this.canvas = $('canvas#main')[0];
					if (!this.canvas.getContext || !this.canvas.getContext("2d")) {
						alert('お使いのブラウザではお楽しみ頂くことができません');
					}
					this.context = this.canvas.getContext("2d");
					
					this.image = new Image();
					this.image.onload = (function(image, self){
						return function(e){
							callback.call();
						};
					})(this.image, this);
					this.image.src = this.IMAGE_URL;
					
					return this;
				},
				reset: function(){
					var imageCanvas = $('<canvas width="' + this.image.width + '" height="' + this.image.height + '" />')[0];
					var imageContext = imageCanvas.getContext("2d");
					imageContext.drawImage(this.image, 0, 0);
					
					this.vertices = [];
					var cycles = [-1, -2, 2, 4];
					for (var x = 0; x < this.image.width; x++) {
						var _line = [];
						for (var y = 0; y < this.image.height; y++) {
							var vertex = new Vertex(x, y);
							vertex.data = imageContext.getImageData(x, y, 1, 1).data;
							vertex.cycleX = cycles[Math.floor(cycles.length * Math.random())]; //Math.random() * 15;
							vertex.cycleY = cycles[Math.floor(cycles.length * Math.random())]; //Math.random() * 15;
							_line[y] = vertex;
						}
						this.vertices[x] = _line;
					}
					// 最初から揃っているとつまらないのでわざと周期をずらす
					this.counter = Math.round(Math.PI * this.counterScale / (cycles[cycles.length - 1] - 1));
					return this;
				},
				start: function(){
					this.drawTimer = setInterval((function(self){
						return function(){
							self.draw();
						}
					})(this), this.drawDelay);
					return this;
				},
				draw: function(){
					//if (this.counter % 2 == 0) {
					//	this.context.clearRect(0, 0, this.context.width, this.context.height);
					//}
					for (var x = 0; x < this.vertices.length; x++) {
						for (var y = 0; y < this.vertices[x].length; y++) {
							var vertex = this.vertices[x][y];
							vertex.makePosition(this.counter / this.counterScale, this.WAVE_LENGTH);
							var d = vertex.data;
							this.context.fillStyle = "rgb(" + [d[0], d[1], d[2]].join() + ")";
							this.context.fillRect(vertex.x * this.IMAGE_SCALE, vertex.y * this.IMAGE_SCALE, this.IMAGE_SCALE, this.IMAGE_SCALE);
						}
					}
					if (this.counter + 5 > this.MAX_COUNTER) {
						this.counter += Math.max(0.1, 1 - this.counter / this.MAX_COUNTER);
					} else {
						this.counter += 2;
					}
					this.counter = this.counter % this.MAX_COUNTER;
				}
			};
			var Vertex = function(x, y){
				this.x = x;
				this.y = y;
				this.goalX = x;
				this.goalY = y;
				this.makePosition = function(i, length){
					this.x = this.goalX + Math.sin(i * this.cycleX) * length;
					this.y = this.goalY + Math.sin(i * this.cycleY) * length;
					//this.x = this.goalX + Math.sin(i) * this.cycleX;
					//this.y = this.goalY + Math.sin(i) * this.cycleY;
				};
			};
			
			(function($){
				$(document).ready(function(){
					main.init(function(){
						main.reset().start();
					});
				});
			})(jQuery);
		</script>
	</head>
	<body>
		<canvas id="main" width="312px" height="243px" />
	</body>
</html>
